<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorir√§knare + Livsmedelss√∂kning</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; }
        h1, h2 { text-align: center; }
        input, select, button { margin: 5px 0; padding: 10px; width: 100%; box-sizing: border-box; }
        .meal-list ul, .week-summary ul { padding-left: 0; list-style: none; }
        .meal-list li, .week-summary li { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .remove-btn { margin-left: 10px; background-color: red; color: white; border: none; padding: 4px 8px; cursor: pointer; }
        .total { font-weight: bold; margin-top: 10px; }
        .result-item { border: 1px solid #ccc; padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üçΩÔ∏è Kalorir√§knare</h1>

    <label for="date">V√§lj datum:</label>
    <input type="date" id="date">

    <label for="mealType">M√•ltidstyp:</label>
    <select id="mealType">
        <option value="Frukost">Frukost</option>
        <option value="Lunch">Lunch</option>
        <option value="Middag">Middag</option>
        <option value="Mellanm√•l">Mellanm√•l</option>
    </select>

    <label for="calories">Kalorier:</label>
    <input type="number" id="calories" placeholder="t.ex. 500 kcal">
    <button onclick="addMeal()">L√§gg till m√•ltid</button>

    <div class="meal-list">
        <h2>Dagens m√•ltider</h2>
        <ul id="mealList"></ul>
        <div class="total" id="totalCalories">Totalt: 0 kcal</div>
    </div>

    <div class="week-summary">
        <h2>Vecko√∂versikt (m√•n‚Äìs√∂n)</h2>
        <ul id="weekSummary"></ul>
    </div>

    <div class="search-section">
        <h2>üîç S√∂k livsmedel</h2>
        <input type="text" id="searchInput" placeholder="Skriv t.ex. 'banan'">
        <button onclick="searchFood()">S√∂k</button>
        <div id="searchResults"></div>
    </div>

    <script>
        const mealList = document.getElementById("mealList");
        const totalCaloriesEl = document.getElementById("totalCalories");
        const caloriesInput = document.getElementById("calories");
        const dateInput = document.getElementById("date");
        const mealTypeInput = document.getElementById("mealType");
        const weekSummary = document.getElementById("weekSummary");
        const searchInput = document.getElementById("searchInput");
        const searchResults = document.getElementById("searchResults");

        function loadMeals() {
            mealList.innerHTML = "";
            const date = dateInput.value;
            if (!date) return;

            const data = JSON.parse(localStorage.getItem("caloriesData") || "{}");
            const meals = data[date] || [];
            let total = 0;

            meals.forEach((meal, index) => {
                const li = document.createElement("li");
                li.innerHTML = `<span>${meal.type}: ${meal.kcal} kcal</span> <button class="remove-btn" onclick="removeMeal(${index})">Ta bort</button>`;
                mealList.appendChild(li);
                total += meal.kcal;
            });

            totalCaloriesEl.textContent = `Totalt: ${total} kcal`;
            updateWeekSummary();
        }

        function addMeal() {
            const kcal = parseInt(caloriesInput.value);
            const date = dateInput.value;
            const type = mealTypeInput.value;
            if (!kcal || !date) return;

            const data = JSON.parse(localStorage.getItem("caloriesData") || "{}");
            if (!data[date]) data[date] = [];
            data[date].push({ type, kcal });
            localStorage.setItem("caloriesData", JSON.stringify(data));

            caloriesInput.value = "";
            loadMeals();
        }

        function removeMeal(index) {
            const date = dateInput.value;
            const data = JSON.parse(localStorage.getItem("caloriesData") || "{}");
            if (!data[date]) return;
            data[date].splice(index, 1);
            localStorage.setItem("caloriesData", JSON.stringify(data));
            loadMeals();
        }

        function updateWeekSummary() {
            const data = JSON.parse(localStorage.getItem("caloriesData") || "{}");
            const selectedDate = new Date(dateInput.value);
            const week = getWeekRange(selectedDate);
            weekSummary.innerHTML = "";

            for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                const dayStr = d.toISOString().split("T")[0];
                const meals = data[dayStr] || [];
                const total = meals.reduce((sum, m) => sum + m.kcal, 0);
                const li = document.createElement("li");
                li.textContent = `${dayStr} ‚Äì ${total} kcal`;
                weekSummary.appendChild(li);
            }
        }

        function getWeekRange(date) {
            const day = date.getDay();
            const diffToMonday = (day === 0 ? -6 : 1) - day;
            const monday = new Date(date);
            monday.setDate(date.getDate() + diffToMonday);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: monday, end: sunday };
        }

        async function searchFood() {
            const searchTerm = searchInput.value.trim();
            if (!searchTerm) return;
            searchResults.innerHTML = "S√∂ker...";

            try {
                const response = await fetch(`https://dataportal.livsmedelsverket.se/api/v1/livsmedel?namn=${encodeURIComponent(searchTerm)}`);
                const results = await response.json();

                searchResults.innerHTML = "";

                for (const item of results) {
                    const details = await fetch(`https://dataportal.livsmedelsverket.se/api/v1/livsmedel/${item.nummer}`);
                    const food = await details.json();
                    const nutrients = food.naringsvarden;

                    const energi = nutrients.find(n => n.namn === "Energi (kcal)")?.varde || 0;
                    const fett = nutrients.find(n => n.namn === "Fett")?.varde || 0;
                    const kolhydrater = nutrients.find(n => n.namn === "Kolhydrater")?.varde || 0;
                    const socker = nutrients.find(n => n.namn === "Sockerarter")?.varde || 0;
                    const protein = nutrients.find(n => n.namn === "Protein")?.varde || 0;

                    const div = document.createElement("div");
                    div.className = "result-item";
                    div.innerHTML = `<strong>${food.namn}</strong><br>
                        Kalorier: ${energi} kcal<br>
                        Fett: ${fett} g<br>
                        Kolhydrater: ${kolhydrater} g<br>
                        Sockerarter: ${socker} g<br>
                        Protein: ${protein} g`;
                    searchResults.appendChild(div);
                }
            } catch (e) {
                searchResults.innerHTML = "Kunde inte h√§mta data.";
            }
        }

        dateInput.addEventListener("change", loadMeals);
        window.addEventListener("load", () => {
            const today = new Date().toISOString().split("T")[0];
            dateInput.value = today;
            loadMeals();
        });
    </script>
</body>
</html>
